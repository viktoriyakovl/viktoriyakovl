# Смена email в профиле пользователя
--

## Описание сценария

После авторизации и входа пользователя в "Настройки профиля", пользователь может сменить, подтвердить или добавить email.
Когда пользователь инициирует смену email (не важно, подтвержденного или нет), Frontend отправляет в Auth запрос на начало процесса смены email (1160).
Далее Auth проводит ряд действий для подтверждения пользователем текущего email:

- Auth отправляет данные для формирования кода/ссылки подтверждения в Guard (8801);
- Guard формирует необходимые данные и отправляет их в Redis для дальнейшей сверки (5001) и в Kafka, откуда данные забирает Notificator (8802);
- Notificator формирует письмо по запрошенному шаблону (на языке пользователя - получая из Localizator посредством функции Middleware), наполняет его полученными данными и отправляет пользователю через SMTP (9100).

Если пользователь не получил письмо с кодом, он может запросить его повторно.

Получив письмо, пользователь вводит указанный в нем код в соответствующую форму на сайте и Frontend отправляет его для сверки в Gurd (1161, 5002).
1. Если код введен верно, пользователю на сайте отображается форма для ввода нового email, после заполнения которой Frontend отправляет в Auth запрос на проверку возможности привязки указанного email (1162). Если новый email уже привязан к действующему аккаунту, пользователю отобразится соответствующая ошибка (409 код) и будет предложено указать другой email.
2. Если указанный email успешно прошел валидацию, Frontend отправляет запрос в Auth на удаление старой почты и привязку новой к аккаунту пользователя (1163).

Далее Auth повторяет все вышеописанные действия для отправки письма с кодом подтверждения пользователю.
Для проверки введенного пользователем кода подтверждения уже нового email Frontend отправляет запрос в Guard (1104), который (при успешной сверке) завершает флоу и отправляет данные в Auth для обновления (8803).

В рамках ФТ-22 реализована ограничение времени на подтверждение нового email (time_window). Если оно истечет, пользователю будет отображена соответствующая ошибка.
 
## High-level architecture

<img src="my-portfolio/high-level-architecture/HLA-diagram.png" alt="HLA-diagram" height="600">
 
## Интеграционные потоки
Детали форматов запроса/ответа см. в спецификации API (_здесь предполагается ссылка_).

| Поток | Шаг в сценарии | Описание | Сервис 1 (Инициатор запроса) | Тип запроса | API | Прокси/Шина | Сервис 2 (получатель запроса) | Controller	| Endpoint | 
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1160 | 1 | 	Начало смены email | 	Frontend | 	PUT | 	/api/auth/users/{example} | 	BFF | 	Auth | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 8801 | 	2	 | Передача данных и настроек для создания кода подтверждения текущего email | 	Auth | 	POST | 	/1.0/admin/{example} | 	-	 | Guard | 	_название контроллера_ | 	адрес эндпоинта | 
| 5001 | 	3	 | Запись данных в оперативное хранилище (для дальнейшей проверки) | 	Guard	 | -	 | -	 | -	 | Redis	 | - | - | 
| 8802 | 	4	 | Создание и передача кода подтверждения email	 | Guard | 	- | 	- | 	Kafka / topic Name	 | Notificator | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 8809 | 	5	 | Получение текста письма | 	Notificator	 | -	 | -	 |  -	 | Localizator | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 9100 | 	6	 | Создание по шаблону письма для подтверждения email и его отправка пользователю	 | Notificator | 	-	 | -	 | -	 | SMTP	 | -	 |  - | 
| 1161 | 	7.1, 8	 | Подтверждение пользователем текущего email	 | Frontend	 | POST	 | /api/guard/{example} | 	BFF | 	Guard | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 5002 | 	7.2	 | Чтение данных из оперативного хранилища (для проверки)	 | Guard | 	- | 	- | 	- | 	Redis | 	- | 	 - | 
| 1162 | 	9.1, 9.2	 | Проверка на конфликты привязки нового email | 	Frontend | 	GET | 	/api/auth/users/{example} | 	BFF | 	Auth | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 1163 | 	10 | 	Запрос на подтверждение нового email	 | Frontend	 | PUT | 	/api/auth/users/{example}	 | BFF | 	Auth	 | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 8801 | 	11	 | Передача данных и настроек для создания кода подтверждения email | 	Auth	 | POST | 	/1.0/admin/{example} | 	-	 | Guard | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 5001 | 	12	 | Запись данных в оперативное хранилище (для дальнейшей проверки) | 	Guard	 | -	 | -	 | - | 	Redis | 	- | 	- | 
| 8802 | 	13 | 	Создание и передача кода подтверждения email	 | Guard | 	- | 	- | 	Kafka / topic Name	 | Notificator | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 8809 | 	14	 | Получение текста письма | 	Notificator | 	-	 | - |  - | 	Localizator	| 	_название контроллера_	 | _адрес эндпоинта_ | 
| 9100 | 	15	 | Создание по шаблону письма для подтверждения email и его отправка пользователю (посредством сервиса SMTP) | 	Notificator	 | - | 	-	 | -	 | SMTP	  | -	 | - | 
| 1104 | 	16.1, 17	 | Проверка введенного кода для подтверждения email	 | Frontend	 | POST | 	/api/guard/{example} | 	BFF | 	Guard	| 	_название контроллера_	 | _адрес эндпоинта_ | 
| 5002 | 	16.2 | 	Чтение данных из оперативного хранилища (для проверки)	 | Guard	 | - | 	-	 | - | Redis	 | - | 	 - | 
| 8803 | 	18	 | Завершение сессии смены email | Guard | 	-	 | - | 	- | 	Auth	 | 	_название контроллера_	 | _адрес эндпоинта_ | 
| 1105 | 	19 | 	Передача на Frontend token	 | Guard	 | - | 	-	 | BFF	 | Frontend	 | - | 	- | 


